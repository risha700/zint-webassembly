<!DOCTYPE html>
<html>
  <head>
    <title>JS in-browser barcode maker</title>
    </head>
    <body style="background:bisque;">
      <h1>Barcode maker</h1>
       <form id="formContainer"> 
        <label>
            <input id="barcodeType" placeholder="barcode type" type="number">
        </label>
        <label>
            <input id="barcodeText" placeholder="barcode text" type="text">
        </label>
        <button type="submit">Create Barcode</button>
       </form>
    <img src=""/>
      <script type="text/javascript">
        let barcodetxt = document.getElementById('barcode-text')
        let barcodetype = document.getElementById('barcode-type')
        let formContainer = document.getElementById('formContainer')
        formContainer.addEventListener('submit',(e)=>{
            e.preventDefault();
            // console.log("PostMSG:", e);
            // console.log(Object.fromEntries(new/ FormData(e.target).entries()));
            worker.postMessage({'barcodeType':1, 'barcodeText':'anytest'});
            // snapshot();

        });
        var canvas = document.createElement('canvas');
        document.body.appendChild(canvas);

        var worker = new Worker('zint-processor.js');

        worker.onmessage = function(e) {
            // console.log('onMsg:', e)
            drawOutputBitmap(e.data);

            // var data = result.buffer;
            
        };
        function requestBarcode(e, data){
            e.preventDefault();
            // console.log("PostMSG:", data);
            worker.postMessage(data);

        }
        function drawOutputBitmap(data) {
            var result = new Uint8Array(data[0][0])
            var ctx = canvas.getContext('2d');
            // var img = document.getElementsByTagName('img')[0]
            var blob = new Blob( new Uint8Array(result.buffer), { type: 'image/png' } );

            var decodedBlob=ab2str(blob.arrayBuffer())
            // imageData.data.set(blob)
            createImageBitmap(decodedBlob).then((sprite)=>{
                console.log(sprite);
                
                ctx.putImageData(sprite[0], 0, 0)
            })

            // document.body.appendChild(drawArray(result, 32)); 
            // console.log(data);
            // // var bmpFile = new Blob( new Uint8Array(result.buffer), { type: 'image/bmp' } );
            // // let imageData = ctx.createImageData(50, 50);
            // var imageData = ctx.createImageData(data[0][1], data[0][2]);

            // imageData.data.set(result);
            // ctx.putImageData(imageData, 0, 0); 
        }
        function ab2str(buf) {  
            return String.fromCharCode.apply(null, new Uint8Array(buf));
            }
        function str2ab(str) {
            var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
            var bufView = new Uint8Array(buf);
            for (var i=0, strLen=str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }


function drawArray(arr, depth) {
  var offset, height, data, image;

  function conv(size) {
    return String.fromCharCode(size&0xff, (size>>8)&0xff, (size>>16)&0xff, (size>>24)&0xff);
  }

  offset = depth <= 8 ? 54 + Math.pow(2, depth)*4 : 54;
  height = Math.ceil(Math.sqrt(arr.length * 8/depth));

  //BMP Header
  data  = 'BM';                          // ID field
  data += conv(offset + arr.length);     // BMP size
  data += conv(0);                       // unused
  data += conv(offset);                  // pixel data offset
  
  //DIB Header
  data += conv(40);                      // DIB header length
  data += conv(height);                  // image height
  data += conv(height);                  // image width
  data += String.fromCharCode(1, 0);     // colour panes
  data += String.fromCharCode(depth, 0); // bits per pixel
  data += conv(0);                       // compression method
  data += conv(arr.length);              // size of the raw data
  data += conv(2835);                    // horizontal print resolution
  data += conv(2835);                    // vertical print resolution
  data += conv(0);                       // colour palette, 0 == 2^n
  data += conv(0);                       // important colours
  
  //Grayscale tables for bit depths <= 8
  if (depth <= 8) {
    data += conv(0);
    
    for (var s = Math.floor(255/(Math.pow(2, depth)-1)), i = s; i < 256; i += s)  {
      data += conv(i + i*256 + i*65536);
    }
  }
  
  //Pixel data
  data += String.fromCharCode.apply(String, arr);
 
  //Image element
  image = document.createElement('img');

  image.src = 'data:image/bmp;base64,' + btoa(data);

  return image;
}

      </script>
    </body>
</html>
